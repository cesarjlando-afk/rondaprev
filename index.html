<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Rondas Preventivas</title>
  <meta name="theme-color" content="#007bff">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Checklist">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
  <style>
  body {
    font-family: Arial, sans-serif;
    padding: 5vw;
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    background-color: #f9f9f9;
    margin: 0;
  }

  .container {
    width: 100%;
    max-width: 95vw;
    margin: auto;
    padding: 5vw;
  }

  #login, #checklistPage {
    display: none;
  }

  #login.visible, #checklistPage.visible {
    display: block;
  }

  .item {
    margin-bottom: 6vw;
    border: 1px solid #ccc;
    padding: 4vw;
    border-radius: 5px;
    background-color: #fff;
  }

  .controles, .avaliacao, .descricaoExtra {
    display: none;
    margin-top: 10px;
  }

  .item.checked .controles {
    display: block;
  }

  canvas {
    width: 100%;
    max-width: 300px;
    margin-top: 10px;
    display: none;
  }

  input[type="text"],
  input[type="password"] {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    border: 1px solid #ccc;
    border-radius: 5px;
  }

  button {
    margin-top: 10px;
    padding: 12px 24px;
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background-color: #0056b3;
  }

  .hora-captura {
    margin-top: 5px;
    font-size: 0.9rem;
    color: #555;
  }

  #dataHoraAtual {
    font-size: clamp(1rem, 2.5vw, 1.2rem);
    margin-bottom: 20px;
    font-weight: bold;
  }

  #blocoCamera {
    margin-top: 20px;
    display: none;
    text-align: center;
  }

  #videoUnico {
    max-height: 250px;
    margin-bottom: 10px;
    width: 100%;
  }

  @media (max-width: 480px) {
    body {
      font-size: 1.1rem;
    }

    .container {
      padding: 6vw;
    }

    button {
      font-size: 1.1rem;
    }
  }
  
    .cabecario {
  background-color: #f0f4f8;
  color: #333;
  padding: 20px;
  text-align: center;
  border-bottom: 1px solid #ccc;
  margin-bottom: 20px;
  font-family: 'Arial', sans-serif;
}

.cabecario h1 {
  font-size: clamp(1.4rem, 4vw, 2rem);
  margin: 0;
}

.cabecario h1 span {
  display: block;
  font-size: clamp(1rem, 3vw, 1.2rem);
  font-weight: normal;
  margin-top: 5px;
}

.cabecario p {
  font-size: clamp(1rem, 2.5vw, 1.2rem);
  margin-top: 10px;
}

</style>
</head>
<body>
  <header class="cabecario">
  <h1>Birmann 29<span></span></h1>
  <p>(Antonio Alves F. Guedes) - B29
Brig. Faria Lima, 3729 - Itaim Bibi, SÃ£o Paulo - SP</p>
</header>
<div id="login" class="visible">
  <h2>Login de Acesso</h2>
  <label>UsuÃ¡rio:</label><br>
  <input type="text" id="usuario"><br>
  <label>Senha:</label><br>
  <input type="password" id="senha"><br>
  <button onclick="verificarLogin()">Entrar</button>
  <div id="erro" style="color: red; margin-top: 10px;"></div>
</div>

<div id="checklistPage">
  <h2>Ronda Preventiva Bravos B29</h2>
  <div id="dataHoraAtual"></div>
  <button onclick="iniciarRonda()">ğŸš€ Iniciar Ronda</button>
<div id="checklist">
    <!-- âœ… Itens 1 a 5 -->
    <div class="item" data-id="1">
      <label><input type="checkbox" class="check" onchange="toggleItem(this)"> Casa de MÃ¡quinas Zona Alta (16Â°Andar)</label>
      <div class="controles">
        <button onclick="abrirCamera(1)">ğŸ“¸ Abrir CÃ¢mera</button>
        <canvas id="canvas1"></canvas>
        <div class="hora-captura"></div>
        <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
      </div>
      <div class="avaliacao">
       <button id="btnConforme1" onclick="avaliarItem(this, true)">âœ… Conforme</button>
        <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
      </div>
      <div class="descricaoExtra">
        <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
        <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
      </div>
    </div>

    <div class="item" data-id="2">
      <label><input type="checkbox" class="check" onchange="toggleItem(this)"> Gerador 2 (16Â°Andar)</label>
      <div class="controles">
        <button onclick="abrirCamera(2)">ğŸ“¸ Abrir CÃ¢mera</button>
        <canvas id="canvas2"></canvas>
        <div class="hora-captura"></div>
        <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
      </div>
      <div class="avaliacao">
       <button id="btnConforme2" onclick="avaliarItem(this, true)">âœ… Conforme</button> <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
      </div>
      <div class="descricaoExtra">
        <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
        <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
      </div>
    </div>

    <div class="item" data-id="3">
      <label><input type="checkbox" class="check" onchange="toggleItem(this)"> CAG 2 (16Â°Andar)</label>
      <div class="controles">
        <button onclick="abrirCamera(3)">ğŸ“¸ Abrir CÃ¢mera</button>
        <canvas id="canvas3"></canvas>
        <div class="hora-captura"></div>
        <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
      </div>
      <div class="avaliacao">
        <button id="btnConforme3" onclick="avaliarItem(this, true)">âœ… Conforme</button>
        <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
      </div>
      <div class="descricaoExtra">
        <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
        <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
      </div>
    </div>

    <div class="item" data-id="4">
      <label><input type="checkbox" class="check" onchange="toggleItem(this)"> DEA (TÃ©rreo)</label>
      <div class="controles">
        <button onclick="abrirCamera(4)">ğŸ“¸ Abrir CÃ¢mera</button>
        <canvas id="canvas4"></canvas>
        <div class="hora-captura"></div>
        <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
      </div>
      <div class="avaliacao">
        <button id="btnConforme4" onclick="avaliarItem(this, true)">âœ… Conforme</button>
        <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
      </div>
      <div class="descricaoExtra">
        <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
        <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
      </div>
    </div>

    <div class="item" data-id="5">
      <label><input type="checkbox" class="check" onchange="toggleItem(this)"> PressurizaÃ§Ã£o (1Â°SS)</label>
      <div class="controles">
        <button onclick="abrirCamera(5)">ğŸ“¸ Abrir CÃ¢mera</button>
        <canvas id="canvas5"></canvas>
        <div class="hora-captura"></div>
        <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
      </div>
      <div class="avaliacao">
        <button id="btnConforme5" onclick="avaliarItem(this, true)">âœ… Conforme</button>
        <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
      </div>
      <div class="descricaoExtra">
        <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
        <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
      </div>
    </div>
    <!-- Item 6: CAG 1 -->
<div class="item" data-id="6">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)"> CAG 1 (1Â°SS)</label>
  <div class="controles">
    <button onclick="abrirCamera(6)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas6"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme6" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>

<!-- Repita a estrutura acima para os itens 7 a 17, alterando o nome e o nÃºmero do ID/canvas -->
<!-- Aqui estÃ£o os nomes para cada item: -->
<!-- 7: 2Â° Subsolo -->
<div class="item" data-id="7">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)"> 2Â° Subsolo</label>
  <div class="controles">
    <button onclick="abrirCamera(7)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas7"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme7" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 8: 3Â° Subsolo -->
<div class="item" data-id="8">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">3Â° Subsolo</label>
  <div class="controles">
    <button onclick="abrirCamera(8)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas8"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme8" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 9: Casa de Bomba Ãgua PotÃ¡vel 4Â°SS -->
<div class="item" data-id="9">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">Casa de Bomba Ãgua PotÃ¡vel (4Â°SS)</label>
  <div class="controles">
    <button onclick="abrirCamera(9)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas9"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme9" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 10: Casa de Bomba de IncÃªndio -->
<div class="item" data-id="10">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">Casa de Bomba de IncÃªndio (5Â°SS)</label>
  <div class="controles">
    <button onclick="abrirCamera(10)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas10"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme10" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 11: Tanque de Diesel -->
<div class="item" data-id="11">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">Tanque de Diesel (5Â°SS)</label>
  <div class="controles">
    <button onclick="abrirCamera(11)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas11"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme11"onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 12: LenÃ§ol FreÃ¡tico -->
<div class="item" data-id="12">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">LenÃ§ol FreÃ¡tico (5Â°SS)</label>
  <div class="controles">
    <button onclick="abrirCamera(12)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas12"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme12" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 13: CAG 1 -->
<div class="item" data-id="13">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">Heliponto</label>
  <div class="controles">
    <button onclick="abrirCamera(13)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas13"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme13"onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 14: Gerador 1 -->
<div class="item" data-id="14">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">Gerador 1 (1Â°SS)</label>
  <div class="controles">
    <button onclick="abrirCamera(14)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas14"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme14" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 15: Registro de Recalque -->
<div class="item" data-id="15">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">Registro de Recalque</label>
  <div class="controles">
    <button onclick="abrirCamera(15)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas15"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme15" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- 16: Casa de Maquinas Zona Baixa -->
<div class="item" data-id="16">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">Casa de Maquinas Zona Baixa (13Â° Andar)</label>
  <div class="controles">
    <button onclick="abrirCamera(16)">ğŸ“¸ Abrir CÃ¢mera</button>
    <button onclick="abrirJustificativa16()">ğŸ“ Justificar</button>
    <canvas id="canvas16"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button id="btnConforme16" onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>

<!-- Modal Justificativa Casa de MÃ¡quinas Zona Baixa -->
<div id="modalJustifica16" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.3); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:340px;">
    <h3>Justificar "Casa de MÃ¡quinas Zona Baixa"</h3>
    <textarea id="justificativa16" placeholder="Digite a justificativa..." style="width:100%;height:60px;"></textarea>
    <div style="margin-top:10px;text-align:right;">
      <button onclick="salvarJustificativa16()">Salvar</button>
      <button onclick="fecharJustificativa16()">Cancelar</button>
    </div>
  </div>
</div>

<!-- 17: Painel de Controle de IncÃªndio -->
<div class="item" data-id="17">
  <label><input type="checkbox" class="check" onchange="toggleItem(this)">Painel Alarme de IncÃªndio (Central)</label>
  <div class="controles">
    <button onclick="abrirCamera(17)">ğŸ“¸ Abrir CÃ¢mera</button>
    <canvas id="canvas17"></canvas>
    <div class="hora-captura"></div>
    <input type="text" placeholder="DescriÃ§Ã£o..." oninput="salvarEstado()">
  </div>
  <div class="avaliacao">
    <button onclick="avaliarItem(this, true)">âœ… Conforme</button>
    <button onclick="avaliarItem(this, false)">âŒ NÃ£o Conforme</button>
  </div>
  <div class="descricaoExtra">
    <input type="text" class="descricaoExtraInput" placeholder="Descreva o problema..." oninput="validarDescricao(this)">
    <button disabled onclick="salvarNaoConforme(this)">ğŸ’¾ Salvar</button>
  </div>
</div>
<!-- Bloco Ãºnico de cÃ¢mera -->
<div id="blocoCamera">
  <video id="videoUnico" autoplay playsinline></video><br>
  <button onclick="capturarFotoUnica()">âœ… Capturar Foto</button>
</div>

<button id="btnPDF" onclick="verificarAntesDeGerar()">ğŸ“„ Gerar PDF</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let streamAtual = null;
let usuarioAtual = "";
let rondaIniciada = false;
let itemAtivo = null;
let horaInicio = null;
let horaTermino = null;

// verifica se existe ronda ativa
if (localStorage.getItem("rondaIniciada") === "true") {
  rondaIniciada = true;
}

const usuariosPermitidos = {
  "Alessandro Caiana": "02476",
  "Cesar Lando": "25242"
};

function verificarLogin() {
  const usuario = document.getElementById("usuario").value.trim();
  const senha = document.getElementById("senha").value.trim();
  const erro = document.getElementById("erro");

  if (usuariosPermitidos[usuario] === senha) {
    usuarioAtual = usuario;
    document.getElementById("login").classList.remove("visible");
    document.getElementById("checklistPage").classList.add("visible");
    restaurarEstado();
  } else {
    erro.innerText = "UsuÃ¡rio ou senha invÃ¡lidos.";
  }
}

// Marca/desmarca item
function toggleItem(checkbox) {
  const item = checkbox.closest('.item');
  if (!rondaIniciada) {
    checkbox.checked = false;
    alert("âš ï¸ Inicie a ronda antes de verificar os itens!");
    return;
  }
  if (checkbox.checked) {
    item.classList.add('checked');
    item.querySelector('.controles').style.display = "block";
  } else {
    item.classList.remove('checked');
    item.querySelector('.controles').style.display = "none";
    item.querySelector('.avaliacao').style.display = "none";
    item.querySelector('.descricaoExtra').style.display = "none";
    item.querySelector('canvas').style.display = "none";
    item.removeAttribute("data-foto");
  }
  verificarChecklistCompleto();
  salvarEstado();
}

// abrir cÃ¢mera
function abrirCamera(id) {
  itemAtivo = id;
  const video = document.getElementById("videoUnico");
  const blocoCamera = document.getElementById("blocoCamera");

  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
  .then(stream => {
    video.srcObject = stream;
    video.style.display = "block";
    blocoCamera.style.display = "block";
    streamAtual = stream;

    setTimeout(() => {
      blocoCamera.scrollIntoView({ behavior: "smooth", block: "center" });
    }, 300);
  })
  .catch(err => {
    alert("Erro ao acessar a cÃ¢mera: " + err.message);
  });
}

// capturar foto Ãºnica
function capturarFotoUnica() {
  if (!itemAtivo) return;

  const video = document.getElementById("videoUnico");
  const canvas = document.getElementById(`canvas${itemAtivo}`);
  const ctx = canvas.getContext('2d');
  canvas.style.display = "block";

  // Original vÃ­deo dimensions
  let width = video.videoWidth;
  let height = video.videoHeight;

  // Detecta orientaÃ§Ã£o da foto
  const isVertical = height > width;

  // Limites ideais para o redimensionamento
  let maxW, maxH;
  if (isVertical) {
    maxW = 800;  // pixels largura mÃ¡xima vertical
    maxH = 1200; // pixels altura mÃ¡xima vertical
  } else {
    maxW = 1200; // pixels largura mÃ¡xima horizontal
    maxH = 800;  // pixels altura mÃ¡xima horizontal
  }

  // Redimensiona garantindo a proporÃ§Ã£o
  if (width > maxW) {
    height = Math.round(height * (maxW / width));
    width = maxW;
  }
  if (height > maxH) {
    width = Math.round(width * (maxH / height));
    height = maxH;
  }

  // Define o novo tamanho do canvas
  canvas.width = width;
  canvas.height = height;
  ctx.drawImage(video, 0, 0, width, height);

  // ğŸ”¹ Salva a imagem capturada no localStorage
  const imgData = canvas.toDataURL("image/jpeg", 0.8);
  localStorage.setItem(`foto_${itemAtivo}`, imgData);

  const hora = new Date().toLocaleString();
  const item = document.querySelector(`.item[data-id="${itemAtivo}"]`);
  item.querySelector('.hora-captura').innerText = `Capturado em: ${hora}`;
  item.setAttribute("data-foto", "true");

  // ğŸ”¹ Fecha a cÃ¢mera e esconde o vÃ­deo
  if (streamAtual) {
    streamAtual.getTracks().forEach(track => track.stop());
    streamAtual = null;
    video.style.display = "none";
    document.getElementById("blocoCamera").style.display = "none";
  }

  // ğŸ”¹ Rola a tela de volta para o item correspondente
  item.scrollIntoView({ behavior: "smooth", block: "center" });

  // ğŸ”¹ Ajusta visibilidade dos botÃµes e campos
  item.querySelector('.controles').style.display = "none";
  item.querySelector('.avaliacao').style.display = "block";
  item.querySelector('input[type="text"]').style.display = "none";

  verificarChecklistCompleto();
}

function validarDescricao(input) {
  const btnSalvar = input.nextElementSibling;
  btnSalvar.disabled = input.value.trim() === "";
}

// salvar estado NAO conforme
function salvarNaoConforme(btn) {
  const item = btn.closest('.item');
  const extraInput = item.querySelector('.descricaoExtraInput');
  const descricaoInput = item.querySelector('input[type="text"]');
  descricaoInput.value = extraInput.value.trim();

  salvarEstado();
  item.querySelector('.descricaoExtra').style.display = "none";
  item.querySelector('.controles').style.display = "block";
  descricaoInput.style.display = "block";
}

// botÃ£o PDF fica sempre habilitado
function verificarChecklistCompleto() {
  document.getElementById("btnPDF").disabled = false;
}

// validar antes de gerar PDF
function verificarAntesDeGerar() {
  const itens = document.querySelectorAll('.item');
  let todosValidos = true;

  itens.forEach((item) => {
    const marcado = item.querySelector('.check').checked;
    const descricao = item.querySelector('input[type="text"]').value.trim();
    const canvas = item.querySelector('canvas');
    const temFoto = canvas && canvas.width > 0;
    const itemId = item.getAttribute('data-id');

    // Para o item 16: agora Ã© opcional, nÃ£o exige nada
    if (itemId === "16") {
      // Nenhuma verificaÃ§Ã£o: item 16 pode ficar sem foto, descriÃ§Ã£o ou justificativa
      // NÃ£o faz nada aqui â€” nÃ£o marca como invÃ¡lido!
      return;
    } else {
      // Para os demais, exige normalmente
      if (!marcado || !descricao || !temFoto) {
        todosValidos = false;
        item.style.border = "2px solid red";
        setTimeout(() => {
          item.style.border = "1px solid #ccc";
        }, 8000);
      }
    }
  });

  if (!todosValidos) {
    alert("âš ï¸ Para gerar o PDF, todos os itens (menos Casa de Maquinas Zona Baixa) precisam estar marcados, com descriÃ§Ã£o e foto.");
    return;
  }

  horaTermino = new Date().toLocaleString("pt-BR");
  localStorage.setItem("horaTermino", horaTermino);

  gerarPDF();
}

// gerar PDF
function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  // CONFIGURAÃ‡ÃƒO IDEAL
  const fotoW = 100;      
  const fotoH = 75;       
  const margemEntreFotos = 5;
  const margemTopo = 70;  
  const margemLateral = (pageWidth - fotoW) / 2;

  let y = margemTopo;
  let fotosNaPagina = 0;

  // ğŸ”¹ CABEÃ‡ÃRIO (primeira pÃ¡gina)
  doc.setFontSize(18);
  doc.text("Birmann 29 (AntÃ´nio Alves F. Guedes) - B29", pageWidth / 2, 15, { align: "center" });

  doc.setFontSize(12);
  doc.text(
    "Av. Brig. Faria Lima, 3729 - Itaim Bibi, SÃ£o Paulo - SP",
    pageWidth / 2, 22,
    { align: "center" }
  );
  doc.line(10, 28, pageWidth - 10, 28);

  doc.setFontSize(16);
  doc.text("RelatÃ³rio de Ronda Preventiva", pageWidth / 2, 38, { align: "center" });

  doc.setFontSize(11);
  doc.text(`ResponsÃ¡vel: ${usuarioAtual}`, pageWidth / 2, 50, { align: "center" });
  doc.text(`Data: ${new Date().toLocaleString()}`, pageWidth / 2, 56, { align: "center" });

  // ğŸ”¥ PROCESSAR ITENS (FOTOS + TEXTOS)
  document.querySelectorAll(".item").forEach((item, index) => {
    const nome = item.querySelector("label").innerText.trim();
    const descricao = item.querySelector('input[type="text"]').value.trim();
    const hora = item.querySelector(".hora-captura")?.innerText || "";
    const itemId = item.getAttribute('data-id');
    const canvas = item.querySelector("canvas");

    // ğŸ”¹ Item 16 (Casa de Maquinas Zona Baixa) Ã© opcional
    if (itemId == "16") {
      const temFoto = !!localStorage.getItem(`foto_${itemId}`);
      const temDescricao = descricao.length > 0;
      const temHora = hora.length > 0;
      const justificativa = localStorage.getItem("justifica_16"); // <-- LÃª justificativa
      
      // Se nÃ£o tem absolutamente nada preenchido, pula!
      if (!temFoto && !temDescricao && !temHora && !justificativa) return;

      doc.setFontSize(12);
      doc.text(`${index + 1}. ${nome}`, pageWidth / 2, y, { align: "center" });
      y += 6;
      if (temHora) {
        doc.setFontSize(10);
        doc.text(hora, pageWidth / 2, y, { align: "center" });
        y += 6;
      }
      if (temDescricao) {
        doc.setFontSize(11);
        doc.text(`DescriÃ§Ã£o: ${descricao}`, pageWidth / 2, y, { align: "center" });
        y += 8;
      }
      // Exibe justificativa se houver
      if (justificativa) {
        doc.setFontSize(11);
        doc.text(`Justificativa: ${justificativa}`, pageWidth / 2, y, { align: "center" });
        y += 8;
      }
      // SÃ³ adiciona foto se realmente foi capturada e existe em localStorage!
      if (temFoto) {
        const imgData = localStorage.getItem(`foto_${itemId}`);
        if (imgData) {
          doc.addImage(imgData, "JPEG", margemLateral, y, fotoW, fotoH);
          y += fotoH + margemEntreFotos;
          fotosNaPagina++;
        }
      }
      return;
    }

    // Para todos os outros, exige foto salva no localStorage!
    const imgData = localStorage.getItem(`foto_${itemId}`);
    if (!canvas || canvas.width === 0 || !imgData) return;

    // ğŸ”¹ SE NÃƒO FOR PRIMEIRA FOTO E NÃƒO CABE DUAS â†’ NOVA PÃGINA
    if (fotosNaPagina === 2) {
      doc.addPage();
      y = 20;
      fotosNaPagina = 0;
    }

    // ğŸ”¹ TEXTOS
    doc.setFontSize(12);
    doc.text(`${index + 1}. ${nome}`, pageWidth / 2, y, { align: "center" });
    y += 6;

    if (hora) {
      doc.setFontSize(10);
      doc.text(hora, pageWidth / 2, y, { align: "center" });
      y += 6;
    }
    doc.setFontSize(11);
    doc.text(`DescriÃ§Ã£o: ${descricao}`, pageWidth / 2, y, { align: "center" });
    y += 8;

    // ğŸ”¹ IMAGEM
    doc.addImage(imgData, "JPEG", margemLateral, y, fotoW, fotoH);
    y += fotoH + margemEntreFotos;
    fotosNaPagina++;
  });

  // ğŸ”¹ RODAPÃ‰
  const hInicio = localStorage.getItem("horaInicio") || "NÃ£o informado";
  const hTermino = localStorage.getItem("horaTermino") || "NÃ£o informado";

  doc.setFontSize(10);
  doc.text(
    `Ronda iniciada: ${hInicio}  |  Ronda finalizada: ${hTermino}`,
    pageWidth / 2,
    pageHeight - 10,
    { align: "center" }
  );

  // ğŸ”¹ SALVAR PDF e exibir alert
  const nomeArquivo = `Ronda_${usuarioAtual}_${new Date().toLocaleDateString()}_${Date.now()}.pdf`;
  doc.save(nomeArquivo);
  alert("âœ… PDF gerado com sucesso!");
}


// iniciar ronda
function iniciarRonda() {
  if (confirm("Tem certeza que deseja iniciar uma nova ronda?")) {

    // Limpa horÃ¡rios anteriores
    localStorage.removeItem("horaInicio");
    localStorage.removeItem("horaTermino");

    // Limpa fotos salvas dos itens
    document.querySelectorAll('.item').forEach(item => {
      const itemId = item.getAttribute('data-id');
      localStorage.removeItem(`foto_${itemId}`);
    });

    // Limpa outros dados (checklist, justificativas)
    localStorage.removeItem(`checklist_${usuarioAtual}`);
    localStorage.removeItem("rondaIniciada");
    localStorage.removeItem("justifica_16");

    // Agora grava o novo inÃ­cio da ronda
    horaInicio = new Date().toLocaleString("pt-BR");
    localStorage.setItem("horaInicio", horaInicio);

    rondaIniciada = true;
    localStorage.setItem("rondaIniciada", "true");

    document.querySelectorAll('.item').forEach(item => {
      item.classList.remove('checked');
      item.querySelector('.check').checked = false;
      item.querySelector('input[type="text"]').value = "";
      item.querySelector('.hora-captura').innerText = "";
      item.querySelector('canvas').style.display = "none";
      item.querySelector('.controles').style.display = "none";
      item.querySelector('.avaliacao').style.display = "none";
      item.querySelector('.descricaoExtra').style.display = "none";
      item.querySelector('input[type="text"]').style.display = "block";
      item.removeAttribute("data-foto");
    });

    alert("âœ… Ronda iniciada com sucesso!");
    verificarChecklistCompleto();
  }
}

// salvar estado
function salvarEstado() {
  const itens = document.querySelectorAll('.item');
  const dados = [];

  itens.forEach((item) => {
    const check = item.querySelector('.check').checked;
    const descricao = item.querySelector('input[type="text"]').value;
    const hora = item.querySelector('.hora-captura')?.innerText || "";
    const foto = item.getAttribute("data-foto") === "true";

    dados.push({ check, descricao, hora, foto });
  });

  localStorage.setItem(`checklist_${usuarioAtual}`, JSON.stringify(dados));
}

// restaurar estado
function restaurarEstado() {
  const dados = JSON.parse(localStorage.getItem(`checklist_${usuarioAtual}`) || '[]');
  const itens = document.querySelectorAll('.item');

  dados.forEach((dado, index) => {
    const item = itens[index];
    if (!item) return;

    item.querySelector('.check').checked = dado.check;
    item.querySelector('input[type="text"]').value = dado.descricao;
    item.querySelector('.hora-captura').innerText = dado.hora || "";

    if (dado.check) item.classList.add('checked');
    if (dado.foto) item.setAttribute("data-foto", "true");
  });

  verificarChecklistCompleto();
}

// avaliaÃ§Ã£o
function avaliarItem(btn, conforme) {
  const item = btn.closest('.item');
  const descricaoInput = item.querySelector('input[type="text"]');

  if (conforme) {
    descricaoInput.value = "Conforme";
    salvarEstado();
    item.querySelector('.avaliacao').style.display = "none";
    item.querySelector('.controles').style.display = "block";
    descricaoInput.style.display = "block";
  } else {
    item.querySelector('.avaliacao').style.display = "none";
    item.querySelector('.descricaoExtra').style.display = "block";
  }
}

// relÃ³gio
function atualizarDataHora() {
  const agora = new Date();
  const formatado = agora.toLocaleString('pt-BR', {
    weekday: 'long',
    day: '2-digit',
    month: 'long',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  document.getElementById("dataHoraAtual").innerText = `ğŸ•’ ${formatado}`;
}

setInterval(atualizarDataHora, 1000);

// registrar service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registrado"))
    .catch(err => console.log("Erro SW:", err));
}

function abrirJustificativa16() {
  document.getElementById("modalJustifica16").style.display = "flex";
  document.getElementById("justificativa16").value = localStorage.getItem("justifica_16") || "";
}
function fecharJustificativa16() {
  document.getElementById("modalJustifica16").style.display = "none";
}
function salvarJustificativa16() {
  const texto = document.getElementById("justificativa16").value.trim();
  if (!texto) {
    alert("Digite sua justificativa.");
    return;
  }
  localStorage.setItem("justifica_16", texto);
  fecharJustificativa16();
  alert("Justificativa salva para Casa de Maquinas Zona Baixa!");
}

// RESTAURAR FOTOS APÃ“S ATUALIZAR (correÃ§Ã£o definitiva)
window.addEventListener("load", () => {
  document.querySelectorAll('.item').forEach((item) => {
    const id = item.getAttribute("data-id");
    const canvas = document.getElementById(`canvas${id}`);
    if (!canvas) return;

    const savedImage = localStorage.getItem(`foto_${id}`);

    if (savedImage) {
      const img = new Image();

      img.onload = () => {
        const ctx = canvas.getContext("2d");

        // ajusta tamanho antes de desenhar
        canvas.width = img.width;
        canvas.height = img.height;

        canvas.style.display = "block";
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        item.setAttribute("data-foto", "true");
      };

      img.src = savedImage;
    }
  });
});
</script>

</body>
</html>